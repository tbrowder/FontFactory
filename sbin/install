#!/usr/bin/env raku

use QueryOS;
use FreeFont::Utils;

# run by Build.rakumod upon zef install
# install MICR font and license

my $home = %*ENV<HOME>:exists ??
           %*ENV<HOME> !! 0;
if not $home {
    die "FATAL: Unable to determine a \$HOME directory for the user.";
}

my $fil  = "micrenc.ttf";
my $dir  = "$home/.FreeFont";

# need some args to allow testing and
# installation
my $tfil = "dev/Build.rakumod";
if $tfil.IO.e {
    $home = $*CWD; 
    $dir  = "$home/xt/FreeFont";
}

my $f = "$dir/config.yml";
# don't continue if it exists
my $res = True;;
if $f.IO.r {
    say "File '$f' exists.";
    say "Checking for validity...";
    $res = check-config $f;
    if $res {
        say "Installation complete.";
    }
    else {
        say "Invalid file...correcting it.";
    }
}
if not $res {
    say "Creating file '$f'...";
}


# get the path data if and only if
# the collection is on the local file
# system. notify the user if it's not

# some files are in /resources:
#   DigitalGraphicLabs.html
#   license.txt
#   micrenc.ttf

my $r1 = $?DISTRIBUTION.content("resources/DigitalGraphicLabs.html");
my $r2 = $?DISTRIBUTION.content("resources/license.txt");
my $r3 = $?DISTRIBUTION.content("resources/micrenc.ttf");

# query locate-font

# write the data
mkdir $dir;
my $fh = open $f, :w; 
$fh.close;

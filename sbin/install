#!/usr/bin/env raku

use QueryOS;

use FreeFont;
use FreeFont::BuildUtils;
use FreeFont::Utils;
use FreeFont::Resources;
use FreeFont::Config;

my $debug = 1;

# run by Build.rakumod upon zef install
# MICR et alii fonts, licenses, and 
# supporting material

my $home = %*ENV<HOME>:exists ??
           %*ENV<HOME> !! 0;
if not $home {
    die "FATAL: Unable to determine a \$HOME directory for the user.";
}

my $dotFreeFont = ".FreeFont";

# need some args to allow testing and
# installation
my $tfil = "dev/Build.rakumod";
if $tfil.IO.e {
    $home = $*CWD; 
    $dotFreeFont = "xt/FreeFont";
}

my $f = "$home/$dotFreeFont/Config.yml";
say "DEBUG: config file: '$f'" if $debug;

# don't continue if it exists
my $res = False;
if $f.IO.r {
    say "File '$f' exists.";
    say "Checking for validity...";
    $res = check-config $f, :$debug;
    if $res {
        say "Installation complete.";
    }
    else {
        say "Invalid file...correcting it.";
        $res = False;
    }
}
else {
}


if $debug {
    print "DEBUG: status of \$res: ";
    say $res
}

if not $res {
    say "Creating file '$f'...";
    create-config :$home, :$dotFreeFont, :$debug;
    # and check again?
    $res = check-config $f, :$debug;
    if $res {
        say "Installation complete.";
    }
    else {
        say "Still an an invalid config file!";
        $res = False;
    }
}

# Get the path data if and only if
# the collection is on the local file
# system. Notify the user if it's not.

# many files are in /resources:
#   DigitalGraphicLabs.html
#   license.txt
#   micrenc.ttf
#   ...

my @fils = get-resources-hash.keys.sort;

if $debug {
    say "DEBUG: resources list:";
    say "  $_" for @fils;
}

=finish

# query locate-font

# write the data
mkdir $dir;
my $fh = open $f, :w; 
$fh.close;
